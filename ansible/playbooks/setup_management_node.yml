---
- name: Setup Management Node (Jenkins, Gitea, Portainer, Docker Registry)
  hosts: homelab-mgmt
  become: true

  vars:
    jenkins_home: /srv/jenkins
    registry_home: /srv/registry
    portainer_home: /srv/portainer

  tasks:
    # ============================================================================
    # DOCKER SETUP
    # ============================================================================
    - name: Install prerequisite packages
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: true
      tags:
        - packages
        - docker

    - name: Add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: docker

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
      tags: docker

    - name: Install Docker
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true
      tags: docker

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true
      tags: docker

    - name: Enable Docker service
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started
      tags: docker

    # ============================================================================
    # JENKINS
    # ============================================================================
    - name: Create Jenkins data directory
      ansible.builtin.file:
        path: "{{ jenkins_home }}"
        state: directory
        owner: 1000
        group: 1000
        mode: "0755"
      tags: jenkins

    - name: Get docker group ID
      ansible.builtin.command: getent group docker
      register: docker_group
      changed_when: false
      tags: jenkins

    - name: Extract docker GID
      ansible.builtin.set_fact:
        docker_gid: "{{ docker_group.stdout.split(':')[2] }}"
      tags: jenkins

    - name: Pull Jenkins Docker image
      community.docker.docker_image:
        name: jenkins/jenkins:lts
        source: pull
      tags: jenkins

    - name: Run Jenkins container
      community.docker.docker_container:
        name: jenkins
        image: jenkins/jenkins:lts
        restart_policy: always
        state: started
        user: "jenkins"
        groups:
          - "{{ docker_gid }}"
        ports:
          - "8080:8080"
          - "50000:50000"
        volumes:
          - "{{ jenkins_home }}:/var/jenkins_home"
          - /var/run/docker.sock:/var/run/docker.sock
          - /usr/bin/docker:/usr/bin/docker
          - /usr/libexec/docker/cli-plugins:/usr/libexec/docker/cli-plugins
        env:
          JENKINS_OPTS: "--prefix=/jenkins"
      tags: jenkins

    # ============================================================================
    # PORTAINER
    # ============================================================================
    - name: Create Portainer data directory
      ansible.builtin.file:
        path: "{{ portainer_home }}"
        state: directory
        mode: "0755"
      tags: portainer

    - name: Pull Portainer Docker image
      community.docker.docker_image:
        name: portainer/portainer-ce:latest
        source: pull
      tags: portainer

    - name: Run Portainer container
      community.docker.docker_container:
        name: portainer
        image: portainer/portainer-ce:latest
        restart_policy: always
        state: started
        ports:
          - "9000:9000"
          - "9443:9443"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - "{{ portainer_home }}:/data"
      tags: portainer

    # ============================================================================
    # DOCKER REGISTRY
    # ============================================================================
    - name: Create Docker Registry data directory
      ansible.builtin.file:
        path: "{{ registry_home }}"
        state: directory
        mode: "0755"
      tags: registry

    - name: Pull Docker Registry image
      community.docker.docker_image:
        name: registry:2
        source: pull
      tags: registry

    - name: Run Docker Registry container
      community.docker.docker_container:
        name: registry
        image: registry:2
        restart_policy: always
        state: started
        ports:
          - "5000:5000"
        volumes:
          - "{{ registry_home }}:/var/lib/registry"
        env:
          REGISTRY_STORAGE_DELETE_ENABLED: "true"
      tags: registry

    # ============================================================================
    # FIREWALL
    # ============================================================================
    - name: Open management service ports in firewall
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "8080"   # Jenkins web
        - "50000"  # Jenkins agents
        - "3000"   # Gitea
        - "2222"   # Gitea SSH
        - "9000"   # Portainer HTTP
        - "9443"   # Portainer HTTPS
        - "5000"   # Docker Registry
      tags: firewall

    # ============================================================================
    # POST-INSTALL INFO
    # ============================================================================
    - name: Wait for Jenkins to generate initial admin password
      ansible.builtin.wait_for:
        path: "{{ jenkins_home }}/secrets/initialAdminPassword"
        timeout: 120
      tags: jenkins

    - name: Read Jenkins initial admin password
      ansible.builtin.slurp:
        src: "{{ jenkins_home }}/secrets/initialAdminPassword"
      register: jenkins_password
      tags: jenkins

    - name: Display access information
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Management Node Setup Complete!"
          - "=========================================="
          - "Jenkins: http://{{ ansible_host }}:8080/jenkins"
          - "  Initial password: {{ jenkins_password.content | b64decode | trim }}"
          - ""
          - "Portainer: https://{{ ansible_host }}:9443"
          - "  Create admin password on first login"
          - ""
          - "Docker Registry: http://{{ ansible_host }}:5000"
          - "  Use: docker tag image {{ ansible_host }}:5000/image"
          - "=========================================="
      tags: always # Jenkins agents
        - "9000"   # Portainer HTTP
        - "9443"   # Portainer HTTPS
        - "5000"   # Docker Registry
      tags: firewall