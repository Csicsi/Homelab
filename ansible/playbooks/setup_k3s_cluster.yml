---
- name: Setup k3s Server on Pi4 Node 1
  hosts: pi4-node1
  become: true

  tasks:
    - name: Download k3s installation script
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: "0755"
      tags: install

    - name: Install k3s server
      ansible.builtin.command:
        cmd: /tmp/k3s-install.sh
      environment:
        INSTALL_K3S_EXEC: "server --disable traefik --disable servicelb"
      args:
        creates: /usr/local/bin/k3s
      tags: install

    - name: Wait for k3s to be ready
      ansible.builtin.wait_for:
        path: /var/lib/rancher/k3s/server/node-token
        timeout: 120
      tags: install

    - name: Get k3s node token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token
      tags: token

    - name: Save node token to localhost
      ansible.builtin.copy:
        content: "{{ node_token.content | b64decode }}"
        dest: /tmp/k3s-node-token
        mode: "0600"
      delegate_to: localhost
      become: false
      tags: token

    - name: Create .kube directory
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"
      tags: kubeconfig

    - name: Copy kubeconfig to user home
      ansible.builtin.copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /home/{{ ansible_user }}/.kube/config
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"
      tags: kubeconfig

    - name: Replace localhost with server IP in kubeconfig
      ansible.builtin.replace:
        path: /home/{{ ansible_user }}/.kube/config
        regexp: "127.0.0.1"
        replace: "{{ ansible_host }}"
      tags: kubeconfig

- name: Setup k3s Agent on Pi4 Node 2
  hosts: pi4-node2
  become: true

  tasks:
    - name: Download k3s installation script
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: "0755"
      tags: install

    - name: Read node token from localhost
      ansible.builtin.slurp:
        src: /tmp/k3s-node-token
      register: node_token
      delegate_to: localhost
      become: false
      tags: install

    - name: Install k3s agent
      ansible.builtin.command:
        cmd: /tmp/k3s-install.sh
      environment:
        K3S_URL: "https://192.168.8.20:6443"
        K3S_TOKEN: "{{ node_token.content | b64decode | trim }}"
      args:
        creates: /usr/local/bin/k3s
      tags: install

    - name: Wait for k3s agent to be ready
      ansible.builtin.wait_for:
        port: 10250
        timeout: 120
      tags: install

- name: Verify Cluster
  hosts: pi4-node1
  become: false

  tasks:
    - name: Get cluster nodes
      ansible.builtin.command:
        cmd: kubectl get nodes
      register: nodes_output
      changed_when: false
      tags: verify

    - name: Display cluster nodes
      ansible.builtin.debug:
        msg: "{{ nodes_output.stdout_lines }}"
      tags: verify

    - name: Check node status
      ansible.builtin.command:
        cmd: kubectl get nodes -o wide
      register: nodes_detailed
      changed_when: false
      tags: verify

    - name: Display detailed node info
      ansible.builtin.debug:
        msg: "{{ nodes_detailed.stdout_lines }}"
      tags: verify
