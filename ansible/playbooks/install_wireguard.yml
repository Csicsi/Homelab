---
# Install WireGuard and generate server keys
- name: Update package lists
  ansible.builtin.command:
    cmd: opkg update
  tags: packages

- name: Install WireGuard packages
  ansible.builtin.command:
    cmd: opkg install {{ item }}
  loop:
    - wireguard-tools
    - kmod-wireguard
    - luci-proto-wireguard
  tags: packages
  ignore_errors: true

- name: Check if server private key exists
  ansible.builtin.stat:
    path: /etc/wireguard/server_private.key
  register: server_key
  tags: wireguard

- name: Generate server private key
  ansible.builtin.shell:
    cmd: wg genkey > /etc/wireguard/server_private.key
  when: not server_key.stat.exists
  tags: wireguard

- name: Set server key permissions
  ansible.builtin.file:
    path: /etc/wireguard/server_private.key
    mode: "0600"
  tags: wireguard

- name: Generate server public key
  ansible.builtin.shell:
    cmd: cat /etc/wireguard/server_private.key | wg pubkey > /etc/wireguard/server_public.key
  tags: wireguard

- name: Read server private key
  ansible.builtin.slurp:
    src: /etc/wireguard/server_private.key
  register: server_private_key
  tags: wireguard

- name: Read server public key
  ansible.builtin.slurp:
    src: /etc/wireguard/server_public.key
  register: server_public_key
  tags: wireguard
