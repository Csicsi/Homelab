---
- name: Setup Homer Dashboard on Pi3
  hosts: pi3-utils
  become: true

  vars:
    homer_port: 8081

  tasks:
    - name: Create homer directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /opt/homer
        - /opt/homer/assets
      tags: setup

    - name: Create Homer configuration
      ansible.builtin.copy:
        content: |
          ---
          title: "Homelab Dashboard"
          subtitle: "Infrastructure Services"
          logo: "assets/logo.png"
          header: true
          footer: '<p>Homelab Infrastructure - Last updated: 2025-12-05</p>'

          theme: default
          colors:
            light:
              highlight-primary: "#3367d6"
              highlight-secondary: "#4285f4"
              highlight-hover: "#5a95f5"
              background: "#f5f5f5"
              card-background: "#ffffff"
              text: "#363636"
              text-header: "#424242"
              text-title: "#303030"
              text-subtitle: "#424242"
              card-shadow: rgba(0, 0, 0, 0.1)
              link: "#3273dc"
              link-hover: "#363636"
            dark:
              highlight-primary: "#3367d6"
              highlight-secondary: "#4285f4"
              highlight-hover: "#5a95f5"
              background: "#131313"
              card-background: "#2b2b2b"
              text: "#eaeaea"
              text-header: "#ffffff"
              text-title: "#fafafa"
              text-subtitle: "#f5f5f5"
              card-shadow: rgba(0, 0, 0, 0.4)
              link: "#3273dc"
              link-hover: "#ffdd57"

          links:
            - name: "GitHub Repo"
              icon: "fab fa-github"
              url: "https://github.com/Csicsi/Homelab"
              target: "_blank"

          services:
            - name: "CI/CD & Development"
              icon: "fas fa-code"
              items:
                - name: "Jenkins"
                  logo: "https://www.jenkins.io/images/logos/jenkins/jenkins.svg"
                  subtitle: "Build & Deploy"
                  tag: "server"
                  url: "http://192.168.8.10:9080"
                  target: "_blank"
                - name: "Portfolio Site"
                  icon: "fas fa-globe"
                  subtitle: "Production Website"
                  tag: "server"
                  url: "http://192.168.8.10"
                  target: "_blank"

            - name: "Monitoring & Observability"
              icon: "fas fa-chart-line"
              items:
                - name: "Grafana"
                  logo: "https://grafana.com/static/img/menu/grafana2.svg"
                  subtitle: "Dashboards & Visualization"
                  tag: "k3s"
                  url: "http://192.168.8.21:30030"
                  target: "_blank"
                - name: "Prometheus"
                  logo: "https://prometheus.io/assets/prometheus_logo_grey.svg"
                  subtitle: "Metrics Collection"
                  tag: "k3s"
                  url: "http://192.168.8.21:30090"
                  target: "_blank"

            - name: "Network Services"
              icon: "fas fa-network-wired"
              items:
                - name: "Pi-hole"
                  logo: "https://wp-cdn.pi-hole.net/wp-content/uploads/2016/12/Vortex-R.png"
                  subtitle: "DNS & Ad Blocking"
                  tag: "pi3"
                  url: "http://192.168.8.22:8080/admin"
                  target: "_blank"
                - name: "GL.iNet Router"
                  icon: "fas fa-router"
                  subtitle: "Network Management"
                  tag: "router"
                  url: "http://192.168.8.1"
                  target: "_blank"

            - name: "Infrastructure"
              icon: "fas fa-server"
              items:
                - name: "homelab-main"
                  icon: "fas fa-laptop"
                  subtitle: "x86 Server (192.168.8.10)"
                  tag: "rocky-linux"
                  type: "info"
                - name: "pi4-node1"
                  icon: "fab fa-raspberry-pi"
                  subtitle: "k3s Server (192.168.8.20)"
                  tag: "k3s-server"
                  type: "info"
                - name: "pi4-node2"
                  icon: "fab fa-raspberry-pi"
                  subtitle: "k3s Agent (192.168.8.21)"
                  tag: "k3s-agent"
                  type: "info"
                - name: "pi3-utils"
                  icon: "fab fa-raspberry-pi"
                  subtitle: "Pi-hole & Dashboard (192.168.8.22)"
                  tag: "pi3"
                  type: "info"
        dest: /opt/homer/assets/config.yml
        mode: "0644"
      tags: config

    - name: Create docker-compose.yml for Homer
      ansible.builtin.copy:
        content: |
          services:
            homer:
              container_name: homer
              image: b4bz/homer:latest
              ports:
                - "{{ homer_port }}:8080"
              volumes:
                - /opt/homer/assets:/www/assets
              environment:
                - INIT_ASSETS=0
              restart: unless-stopped
        dest: /opt/homer/docker-compose.yml
        mode: "0644"
      tags: setup

    - name: Start Homer dashboard
      ansible.builtin.shell:
        cmd: docker compose up -d
        chdir: /opt/homer
      tags: start

    - name: Wait for Homer to be ready
      ansible.builtin.wait_for:
        port: "{{ homer_port }}"
        delay: 5
        timeout: 60
      tags: verify

    - name: Open Homer port in firewall
      community.general.ufw:
        rule: allow
        port: "{{ homer_port }}"
        proto: tcp
      tags: firewall

    - name: Display Homer access information
      ansible.builtin.debug:
        msg:
          - "Homer Dashboard deployed successfully!"
          - "Access URL: http://192.168.8.22:{{ homer_port }}"
          - ""
          - "The dashboard includes:"
          - "- Jenkins (CI/CD)"
          - "- Portfolio Site"
          - "- Grafana & Prometheus (Monitoring)"
          - "- Pi-hole (DNS)"
          - "- Router Admin"
          - "- Infrastructure Overview"
      tags: verify
