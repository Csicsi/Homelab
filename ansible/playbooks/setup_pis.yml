---
- name: Setup Raspberry Pis (Post-NVMe Migration)
  hosts: pis
  become: true

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: update

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: full
        autoremove: true
        autoclean: true
      tags: update

    - name: Install essential packages
      ansible.builtin.apt:
        name:
          - vim
          - git
          - curl
          - wget
          - htop
          - net-tools
          - iotop
          - tmux
          - python3-pip
          - python3-requests
          - ufw
          - nfs-common
          - open-iscsi
        state: present
      tags: packages

    # ---------------------------------------------------------------
    # System Configuration
    # ---------------------------------------------------------------

    - name: Set timezone to Europe/Vienna
      community.general.timezone:
        name: Europe/Vienna
      tags: system

    - name: Enable memory cgroup for k3s
      ansible.builtin.lineinfile:
        path: /boot/firmware/cmdline.txt
        backrefs: true
        regexp: "^(.*rootwait.*)$"
        line: '\1 cgroup_memory=1 cgroup_enable=memory'
      notify: Reboot Pi
      tags: system

    # ---------------------------------------------------------------
    # Storage Verification
    # ---------------------------------------------------------------

    - name: Check if root is on NVMe
      ansible.builtin.shell: |
        mount | grep ' / ' | grep -q '/dev/sda'
      register: nvme_check
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display warning if not on NVMe
      ansible.builtin.debug:
        msg: "WARNING: Root filesystem not on NVMe (/dev/sda). Migration may be incomplete."
      when: nvme_check.rc != 0
      tags: verify

    - name: Display filesystem information
      ansible.builtin.command: lsblk -f
      register: lsblk_output
      changed_when: false
      tags: verify

    - name: Show current storage layout
      ansible.builtin.debug:
        var: lsblk_output.stdout_lines
      tags: verify

    # ---------------------------------------------------------------
    # Docker Installation
    # ---------------------------------------------------------------

    - name: Install Docker prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
      tags: docker

    - name: Add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present
        keyring: /usr/share/keyrings/docker-archive-keyring.gpg
      tags: docker

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
      tags: docker

    - name: Install Docker
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: true
      tags: docker

    - name: Enable and start Docker
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true
      tags: docker

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true
      tags: docker

    # ---------------------------------------------------------------
    # Firewall Configuration
    # ---------------------------------------------------------------

    - name: Enable and start UFW
      community.general.ufw:
        state: enabled
        policy: deny
        direction: incoming
      tags: firewall

    - name: Allow SSH
      community.general.ufw:
        rule: allow
        port: "22"
        proto: tcp
      tags: firewall

    - name: Allow k3s API server (Pi4 nodes only)
      community.general.ufw:
        rule: allow
        port: "6443"
        proto: tcp
      when: inventory_hostname in ['pi4-node1', 'pi4-node2']
      tags: firewall

    - name: Allow k3s metrics server (Pi4 nodes only)
      community.general.ufw:
        rule: allow
        port: "10250"
        proto: tcp
      when: inventory_hostname in ['pi4-node1', 'pi4-node2']
      tags: firewall

    # ---------------------------------------------------------------
    # Performance Tuning
    # ---------------------------------------------------------------

    - name: Configure sysctl for performance
      ansible.posix.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-homelab.conf
        reload: true
      loop:
        - { key: "vm.swappiness", value: "10" }
        - { key: "fs.inotify.max_user_watches", value: "524288" }
        - { key: "fs.inotify.max_user_instances", value: "512" }
      tags: performance

    # ---------------------------------------------------------------
    # SSH Hardening
    # ---------------------------------------------------------------

    - name: Disable SSH password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
        state: present
      notify: Restart SSH
      tags: ssh

    - name: Disable SSH root login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin no"
        state: present
      notify: Restart SSH
      tags: ssh

  handlers:
    - name: Reboot Pi
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible for system configuration changes"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime

    - name: Restart SSH
      ansible.builtin.systemd:
        name: ssh
        state: restarted
