---
# WireGuard client key generation and config creation
- name: Read server public key for client generation
  ansible.builtin.slurp:
    src: /etc/wireguard/server_public.key
  register: server_public_key
  when: wireguard_clients is defined and wireguard_clients | length > 0

- name: Ensure local wireguard_clients directory exists with correct permissions
  ansible.builtin.file:
    path: "{{ client_configs_dir }}"
    state: directory
    mode: "0700"
  delegate_to: localhost
  run_once: true
  tags: always
  tags: clients

- name: Create clients directory on router
  ansible.builtin.file:
    path: /etc/wireguard/clients
    state: directory
    mode: "0700"
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Check if client keys already exist
  ansible.builtin.stat:
    path: "/etc/wireguard/clients/{{ item.name }}_private.key"
  register: client_keys_check
  loop: "{{ wireguard_clients }}"
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Generate client private keys
  ansible.builtin.shell:
    cmd: "wg genkey > /etc/wireguard/clients/{{ item.item.name }}_private.key"
  loop: "{{ client_keys_check.results }}"
  when:
    - wireguard_clients is defined and wireguard_clients | length > 0
    - not item.stat.exists
  tags: clients

- name: Set client key permissions
  ansible.builtin.file:
    path: "/etc/wireguard/clients/{{ item.name }}_private.key"
    mode: "0600"
  loop: "{{ wireguard_clients }}"
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Generate client public keys
  ansible.builtin.shell:
    cmd: "cat /etc/wireguard/clients/{{ item.name }}_private.key | wg pubkey > /etc/wireguard/clients/{{ item.name }}_public.key"
  loop: "{{ wireguard_clients }}"
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Read client private keys
  ansible.builtin.slurp:
    src: "/etc/wireguard/clients/{{ item.name }}_private.key"
  register: client_private_keys
  loop: "{{ wireguard_clients }}"
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Read client public keys
  ansible.builtin.slurp:
    src: "/etc/wireguard/clients/{{ item.name }}_public.key"
  register: client_public_keys
  loop: "{{ wireguard_clients }}"
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Get existing WireGuard peers
  ansible.builtin.shell:
    cmd: "uci show network | grep wireguard_wg0 | grep public_key || true"
  register: existing_peers
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Add client peers to WireGuard interface
  ansible.builtin.shell:
    cmd: |
      PEER_EXISTS=$(uci show network | grep "public_key='{{ item.1.content | b64decode | trim }}'" || true)
      if [ -z "$PEER_EXISTS" ]; then
        uci add network wireguard_wg0
        uci set network.@wireguard_wg0[-1]=wireguard_wg0
        uci set network.@wireguard_wg0[-1].public_key='{{ item.1.content | b64decode | trim }}'
        uci set network.@wireguard_wg0[-1].description='{{ item.0.description | default(item.0.name) }}'
        uci add_list network.@wireguard_wg0[-1].allowed_ips='{{ item.0.ip }}/32'
        echo "ADDED"
      else
        echo "EXISTS"
      fi
  loop: "{{ wireguard_clients | zip(client_public_keys.results) | list }}"
  register: peer_add_results
  when: wireguard_clients is defined and wireguard_clients | length > 0
  changed_when: "'ADDED' in peer_add_results.stdout"
  tags: clients

- name: Commit network changes and restart WireGuard for clients
  ansible.builtin.shell:
    cmd: |
      uci commit network
      /etc/init.d/network reload
      ifdown wg0 && sleep 2 && ifup wg0
  when:
    - wireguard_clients is defined and wireguard_clients | length > 0
    - peer_add_results.changed
  tags: clients

- name: Create local directory for client configs
  ansible.builtin.file:
    path: "{{ client_configs_dir }}"
    state: directory
    mode: "0700"
  delegate_to: localhost
  run_once: true
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients

- name: Generate client configuration files
  ansible.builtin.copy:
    content: |
      [Interface]
      PrivateKey = {{ item.1.content | b64decode | trim }}
      Address = {{ item.0.ip }}/24
      DNS = {{ client_dns }}

      [Peer]
      PublicKey = {{ server_public_key.content | b64decode | trim }}
      Endpoint = {{ wireguard_endpoint }}:{{ wireguard_port }}
      AllowedIPs = {{ client_allowed_ips }}
      PersistentKeepalive = {{ client_keepalive }}
    dest: "{{ client_configs_dir }}/{{ item.0.name }}.conf"
    mode: "0600"
  delegate_to: localhost
  loop: "{{ wireguard_clients | zip(client_private_keys.results) | list }}"
  when: wireguard_clients is defined and wireguard_clients | length > 0
  tags: clients
