---
# Deploy Monitoring Stack (Prometheus, Loki, Grafana) to k3s cluster
# and Node Exporters to monitored hosts
#
# Usage:
#   Deploy monitoring stack only (no sudo needed):
#     ansible-playbook -i inventory.yml playbooks/setup_monitoring_stack.yml --limit pi4-node1
#
#   Deploy node exporters to Pis (same sudo password as control machine):
#     ansible-playbook -i inventory.yml playbooks/setup_monitoring_stack.yml --tags node-exporter --limit pis -K
#
#   Deploy node exporter to homelab-main (different sudo password):
#     ansible-playbook -i inventory.yml playbooks/setup_monitoring_stack.yml --tags node-exporter --limit homelab-main -K
#
#   Full deployment (Pis only, requires sudo password):
#     ansible-playbook -i inventory.yml playbooks/setup_monitoring_stack.yml --limit "pi4-node1:pis" -K
#
# Notes:
#   - Separate the Pi and server deployments if they have different sudo passwords
#   - Router monitoring requires separate setup (OpenWrt collectd or custom exporter)
#   - homelab-staging is optional (skipped if offline)
#   - The monitoring stack is deployed to pi4-node1 (k3s control plane)

- name: Deploy Monitoring Stack to k3s
  hosts: pi4-node1
  become: false

  vars:
    monitoring_namespace: monitoring

  tasks:
    - name: Create monitoring namespace
      ansible.builtin.command:
        cmd: kubectl create namespace {{ monitoring_namespace }}
      register: ns_result
      failed_when: ns_result.rc != 0 and 'AlreadyExists' not in ns_result.stderr
      changed_when: ns_result.rc == 0
      tags: namespace

    - name: Label namespace for Pod Security Standards
      ansible.builtin.command:
        cmd: kubectl label namespace {{ monitoring_namespace }} pod-security.kubernetes.io/enforce=privileged --overwrite
      tags: namespace

    - name: Create manifests directory
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/k3s-manifests/monitoring
        state: directory
        mode: "0755"
      tags: manifests

    - name: Deploy Prometheus ConfigMap
      ansible.builtin.copy:
        content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-config
            namespace: {{ monitoring_namespace }}
          data:
            prometheus.yml: |
              global:
                scrape_interval: 15s
                evaluation_interval: 15s
              scrape_configs:
                - job_name: 'prometheus'
                  static_configs:
                    - targets: ['localhost:9090']
                - job_name: 'node-exporter'
                  static_configs:
                    - targets: ['192.168.8.20:9100', '192.168.8.21:9100', '192.168.8.22:9100', '192.168.8.10:9100']
                - job_name: 'kubernetes-nodes'
                  kubernetes_sd_configs:
                    - role: node
                  relabel_configs:
                    - source_labels: [__address__]
                      regex: '(.*):10250'
                      replacement: '${1}:9100'
                      target_label: __address__
        dest: /home/{{ ansible_user }}/k3s-manifests/monitoring/prometheus-config.yaml
        mode: "0644"
      tags: prometheus

    - name: Apply Prometheus ConfigMap
      ansible.builtin.command:
        cmd: kubectl apply -f /home/{{ ansible_user }}/k3s-manifests/monitoring/prometheus-config.yaml
      tags: prometheus

    - name: Deploy Prometheus
      ansible.builtin.copy:
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: {{ monitoring_namespace }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                securityContext:
                  fsGroup: 65534
                initContainers:
                  - name: init-chown-data
                    image: busybox:latest
                    command: ['sh', '-c', 'chown -R 65534:65534 /prometheus']
                    volumeMounts:
                      - name: prometheus-storage
                        mountPath: /prometheus
                containers:
                  - name: prometheus
                    image: prom/prometheus:latest
                    args:
                      - '--config.file=/etc/prometheus/prometheus.yml'
                      - '--storage.tsdb.path=/prometheus'
                      - '--storage.tsdb.retention.time=7d'
                    ports:
                      - containerPort: 9090
                    volumeMounts:
                      - name: prometheus-config
                        mountPath: /etc/prometheus
                      - name: prometheus-storage
                        mountPath: /prometheus
                volumes:
                  - name: prometheus-config
                    configMap:
                      name: prometheus-config
                  - name: prometheus-storage
                    hostPath:
                      path: /var/lib/prometheus
                      type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus
            namespace: {{ monitoring_namespace }}
          spec:
            type: NodePort
            selector:
              app: prometheus
            ports:
              - port: 9090
                targetPort: 9090
                nodePort: 30090
        dest: /home/{{ ansible_user }}/k3s-manifests/monitoring/prometheus.yaml
        mode: "0644"
      tags: prometheus

    - name: Apply Prometheus deployment
      ansible.builtin.command:
        cmd: kubectl apply -f /home/{{ ansible_user }}/k3s-manifests/monitoring/prometheus.yaml
      tags: prometheus

    - name: Deploy Loki
      ansible.builtin.copy:
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: loki
            namespace: {{ monitoring_namespace }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: loki
            template:
              metadata:
                labels:
                  app: loki
              spec:
                securityContext:
                  fsGroup: 10001
                initContainers:
                  - name: init-chown-data
                    image: busybox:latest
                    command: ['sh', '-c', 'chown -R 10001:10001 /loki']
                    volumeMounts:
                      - name: loki-storage
                        mountPath: /loki
                containers:
                  - name: loki
                    image: grafana/loki:latest
                    args:
                      - -config.file=/etc/loki/local-config.yaml
                    ports:
                      - containerPort: 3100
                    volumeMounts:
                      - name: loki-storage
                        mountPath: /loki
                volumes:
                  - name: loki-storage
                    hostPath:
                      path: /var/lib/loki
                      type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: loki
            namespace: {{ monitoring_namespace }}
          spec:
            type: ClusterIP
            selector:
              app: loki
            ports:
              - port: 3100
                targetPort: 3100
        dest: /home/{{ ansible_user }}/k3s-manifests/monitoring/loki.yaml
        mode: "0644"
      tags: loki

    - name: Apply Loki deployment
      ansible.builtin.command:
        cmd: kubectl apply -f /home/{{ ansible_user }}/k3s-manifests/monitoring/loki.yaml
      tags: loki

    - name: Deploy Grafana
      ansible.builtin.copy:
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: {{ monitoring_namespace }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                securityContext:
                  fsGroup: 472
                initContainers:
                  - name: init-chown-data
                    image: busybox:latest
                    command: ['sh', '-c', 'chown -R 472:472 /var/lib/grafana']
                    volumeMounts:
                      - name: grafana-storage
                        mountPath: /var/lib/grafana
                containers:
                  - name: grafana
                    image: grafana/grafana:latest
                    ports:
                      - containerPort: 3000
                    env:
                      - name: GF_SECURITY_ADMIN_PASSWORD
                        value: admin
                    volumeMounts:
                      - name: grafana-storage
                        mountPath: /var/lib/grafana
                volumes:
                  - name: grafana-storage
                    hostPath:
                      path: /var/lib/grafana
                      type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana
            namespace: {{ monitoring_namespace }}
          spec:
            type: NodePort
            selector:
              app: grafana
            ports:
              - port: 3000
                targetPort: 3000
                nodePort: 30030
        dest: /home/{{ ansible_user }}/k3s-manifests/monitoring/grafana.yaml
        mode: "0644"
      tags: grafana

    - name: Apply Grafana deployment
      ansible.builtin.command:
        cmd: kubectl apply -f /home/{{ ansible_user }}/k3s-manifests/monitoring/grafana.yaml
      tags: grafana

    - name: Wait for deployments to be ready
      ansible.builtin.command:
        cmd: kubectl wait --for=condition=available --timeout=300s deployment/{{ item }} -n {{ monitoring_namespace }}
      loop:
        - prometheus
        - loki
        - grafana
      tags: verify

    - name: Get all pods
      ansible.builtin.command:
        cmd: kubectl get pods -n {{ monitoring_namespace }}
      register: pods_output
      changed_when: false
      tags: verify

    - name: Display pods
      ansible.builtin.debug:
        msg: "{{ pods_output.stdout_lines }}"
      tags: verify

    - name: Display access information
      ansible.builtin.debug:
        msg:
          - "Monitoring stack deployed successfully!"
          - "Access URLs:"
          - "  Prometheus: http://192.168.8.20:30090"
          - "  Grafana: http://192.168.8.20:30030 (admin/admin)"
          - ""
          - "To add Prometheus as data source in Grafana:"
          - "  URL: http://prometheus.monitoring.svc.cluster.local:9090"
          - "To add Loki as data source in Grafana:"
          - "  URL: http://loki.monitoring.svc.cluster.local:3100"
      tags: verify

- name: Deploy Node Exporters on Pi nodes
  hosts: pis
  become: true
  gather_facts: true

  tasks:
    - name: Create node-exporter user
      ansible.builtin.user:
        name: node-exporter
        system: true
        shell: /bin/false
        create_home: false
      tags: node-exporter

    - name: Download node exporter
      ansible.builtin.get_url:
        url: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-arm64.tar.gz
        dest: /tmp/node_exporter.tar.gz
        mode: "0644"
      when: "'pi' in inventory_hostname or 'pis' in group_names"
      tags: node-exporter

    - name: Download node exporter (x86_64)
      ansible.builtin.get_url:
        url: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
        dest: /tmp/node_exporter.tar.gz
        mode: "0644"
      when: "'server' in group_names or 'staging' in group_names"
      tags: node-exporter

    - name: Extract node exporter
      ansible.builtin.unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /tmp
        remote_src: true
      tags: node-exporter

    - name: Copy node exporter binary
      ansible.builtin.copy:
        src: "/tmp/node_exporter-1.8.2.linux-{{ 'arm64' if ('pi' in inventory_hostname or 'pis' in group_names) else 'amd64' }}/node_exporter"
        dest: /usr/local/bin/node_exporter
        remote_src: true
        owner: node-exporter
        group: node-exporter
        mode: "0755"
      tags: node-exporter

    - name: Create node exporter systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Prometheus Node Exporter
          After=network.target

          [Service]
          User=node-exporter
          Group=node-exporter
          Type=simple
          ExecStart=/usr/local/bin/node_exporter

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/node_exporter.service
        mode: "0644"
      tags: node-exporter

    - name: Enable and start node exporter
      ansible.builtin.systemd:
        name: node_exporter
        state: started
        enabled: true
        daemon_reload: true
      tags: node-exporter

    - name: Open node exporter port in firewall (Rocky Linux)
      ansible.posix.firewalld:
        port: 9100/tcp
        permanent: true
        immediate: true
        state: enabled
      when: ansible_os_family == "RedHat"
      tags: node-exporter

    - name: Open node exporter port in firewall (Raspberry Pi)
      community.general.ufw:
        rule: allow
        port: "9100"
        proto: tcp
      when: ansible_os_family == "Debian"
      tags: node-exporter

- name: Deploy Node Exporter on x86 servers
  hosts: servers
  become: true
  gather_facts: true
  ignore_unreachable: true

  tasks:
    - name: Create node-exporter user
      ansible.builtin.user:
        name: node-exporter
        system: true
        shell: /bin/false
        create_home: false
      tags: node-exporter

    - name: Download node exporter (x86_64)
      ansible.builtin.get_url:
        url: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
        dest: /tmp/node_exporter.tar.gz
        mode: "0644"
      tags: node-exporter

    - name: Extract node exporter
      ansible.builtin.unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /tmp
        remote_src: true
      tags: node-exporter

    - name: Copy node exporter binary
      ansible.builtin.copy:
        src: /tmp/node_exporter-1.8.2.linux-amd64/node_exporter
        dest: /usr/local/bin/node_exporter
        remote_src: true
        owner: node-exporter
        group: node-exporter
        mode: "0755"
      tags: node-exporter

    - name: Create node exporter systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Prometheus Node Exporter
          After=network.target

          [Service]
          User=node-exporter
          Group=node-exporter
          Type=simple
          ExecStart=/usr/local/bin/node_exporter

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/node_exporter.service
        mode: "0644"
      tags: node-exporter

    - name: Enable and start node exporter
      ansible.builtin.systemd:
        name: node_exporter
        state: started
        enabled: true
        daemon_reload: true
      tags: node-exporter

    - name: Open node exporter port in firewall (Rocky Linux)
      ansible.posix.firewalld:
        port: 9100/tcp
        permanent: true
        immediate: true
        state: enabled
      when: ansible_os_family == "RedHat"
      tags: node-exporter
